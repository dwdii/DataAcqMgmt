---
title: 'Performance Study: R in Parallel'
author: "Daniel Dittenhafer"
date: "Friday, November 21, 2014"
output: html_document
---
```{r, echo=FALSE}
options(warn=-1)
require(knitcitations, quietly=TRUE)
require(RefManageR, quietly=TRUE)

cleanbib()

cite_options(citation_format="text")

bibDoPara <- bibentry(bibtype="Misc", 
             title="Getting Started with doParallel and foreach", 
             author=as.person("Steve Weston, Rich Calaway"),
             year="2014",
             url="http://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf")
             
bibSplitSO <- bibentry(bibtype="Misc", 
             title="Split a vector into three vectors of unequal length in R", 
             author=as.person("Simon O'Hanlon"),
             year="2013",
             url="http://stackoverflow.com/a/18406749")

bibRforeach <- bibentry(bibtype="Misc", 
             title="package foreach, version 1.4.1", 
             author="R Core Team",
             organization="R Foundation for Statistical Computing",
             url="http://www.inside-r.org/packages/cran/foreach/docs/foreach")

bref <- c(bibDoPara, bibSplitSO, bibRforeach)

x <- 1
```

This performance study will compare a simple task, the sum of a vector of integers, using various techniques ranging from the old standard for loop, base R's vectorized `sum` function, and a  doParallel package implementation. The Microbenchmark package will be used to perform the timing measurements. Visualization of the timing measurements will be presented via ggplot2.

```{r}
require(microbenchmark, quietly=TRUE)
require(doParallel, quietly=TRUE)
require(ggplot2, quietly=TRUE)
```

I am running on a 4 core laptop, so I will use 3 cores for this test, leaving one for keeping my machine reasonably responsive. 

```{r}
registerDoParallel(cores=3) 

print(parallel::detectCores())
```

The for loop to be used in this study is wrapped in the function `forLoopSum` and is defined as follows:

```{r}
forLoopSum <- function(x)
{
  sum <- 0
  for( a in x){
    sum <- sum + a
  }
  return (sum)
}
```

The base R `sum` function will be used as is.

```{r}
sum(x)
```

For parallelization, the `doParallel` package will provide the interface to base R's `parallel` package as described in 
```{r, results="asis", echo=FALSE} 
citep(bibDoPara) 
```
. The split approach used to allocate data amongst various batches is taken from a StackOverflow post 
```{r, results='asis', echo=FALSE} 
citep(bibSplitSO) 
```
. Finally, the base R `foreach` function is
used to to iterate over the batches and dispatch them to the parallelizer 
```{r, results="asis", echo=FALSE} 
citep(bibRforeach) 
```
.

```{r}
parallelSum <- function(x) {
  
  items <- length(x)
  batches <- parallel::detectCores()
  batchSize <- items
  batchSets <- split(x, sample(batches, items, replace=TRUE))
  
  finalSum <- foreach(b=iter(batchSets, by='row'), .combine="+") %dopar% sum(b)
  
  return (finalSum)
}
```

```{r}
setSize <- c(1, 2, 3, 4, 5, 6)#, 7, 8)
resultsDF <- data.frame()

for(s in setSize) {
  size <- 10 ^ s
  a <- sample(1:20, size, replace=TRUE)
  
  # Validate
  checkSum <- sum(a)
  print(checkSum)
  print(forLoopSum(a))
  #stopifnot(identical(forLoopSum(a), checkSum))
  stopifnot(identical(parallelSum(a), checkSum))
  
  # Run performance test
  results <- microbenchmark::microbenchmark(forLoopSum(a), 
                                            sum(a), 
                                            parallelSum(a), 
                                            times=10, unit="ms")
  
  agSum <- summary(results)
  agSum <- data.frame(agSum, count = sprintf("10^%d", s))
  
  resultsDF <- rbind(resultsDF, agSum)
  
  #gp <- autoplot(results)
  #gp
}

```
```{r, echo=FALSE}
require(ggplot2)
g2 <- ggplot(data=resultsDF, aes(x=factor(count)))

# for(s in levels(as.factor(resultsDF$expr))) {
#   print(s)
#   subDF <- subset(resultsDF, expr == s, select = c(count, mean))
#   g2 <- g2 + geom_line(data=subDF, aes(x=count, y=mean, colour=s), 
#                        stat="identity")
# }
g2 <- g2 + geom_line(aes(y=mean, group=expr, colour=expr), size=1) 
g2 <- g2 + scale_fill_hue(l=40)
#g2 <- g2 + theme_minimal()
g2 <- g2 + theme(axis.text.x = element_text(angle=30, vjust=1))
g2 <- g2 + guides(colour = guide_legend("Legend"))
g2 <- g2 + labs(title="R Performance - sum function", x="length of vector", y="Time (ms)")
g2
print(resultsDF)
```

#### References ####
```{r, echo=FALSE}
#record_as_cited(bref)

```{r, results='asis', echo=FALSE}
BibOptions(style="html", bib.style="authortitle")
bibliography()
```